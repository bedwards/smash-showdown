name: Verify Mertin-Flemmer

on:
  push:
    branches: [main]
    paths:
      - 'src/mertin-flemmer/**'
      - 'scripts/verify.sh'
  pull_request:
    branches: [main]
    paths:
      - 'src/mertin-flemmer/**'
      - 'scripts/verify.sh'
  workflow_dispatch:

jobs:
  verify:
    name: Run Verification Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make verify script executable
        run: chmod +x scripts/verify.sh

      - name: Run verification
        run: |
          echo "üîç Running Mertin-Flemmer verification..."
          ./scripts/verify.sh
        continue-on-error: false

      - name: Check for Luau syntax (basic)
        run: |
          echo "üîç Checking Luau file syntax..."

          ERRORS=0

          # Check all .luau files exist and aren't empty
          for file in $(find src/mertin-flemmer -name "*.luau" -type f); do
            if [ ! -s "$file" ]; then
              echo "‚ùå Empty file: $file"
              ERRORS=$((ERRORS + 1))
            fi
          done

          # Check for unbalanced brackets
          for file in $(find src/mertin-flemmer -name "*.luau" -type f); do
            opens=$(grep -o '{' "$file" | wc -l)
            closes=$(grep -o '}' "$file" | wc -l)
            if [ "$opens" -ne "$closes" ]; then
              echo "‚ùå Mismatched braces in $file: { = $opens, } = $closes"
              ERRORS=$((ERRORS + 1))
            fi
          done

          if [ $ERRORS -gt 0 ]; then
            echo "‚ùå Found $ERRORS syntax issues"
            exit 1
          fi

          echo "‚úÖ Basic syntax checks passed"

      - name: Security scan
        run: |
          echo "üîí Running security scan..."

          FORBIDDEN="loadstring|getfenv|setfenv|debug\.set"

          if grep -rE "$FORBIDDEN" src/mertin-flemmer --include="*.luau"; then
            echo "‚ùå Forbidden patterns found!"
            exit 1
          fi

          echo "‚úÖ Security scan passed"

      - name: Check file structure
        run: |
          echo "üìÅ Checking file structure..."

          # Required directories
          for dir in server client shared; do
            if [ ! -d "src/mertin-flemmer/$dir" ]; then
              echo "‚ùå Missing directory: src/mertin-flemmer/$dir"
              exit 1
            fi
          done

          # Server scripts should end in .server.luau
          for file in src/mertin-flemmer/server/*.luau; do
            if [[ "$file" != *".server.luau" ]]; then
              echo "‚ö†Ô∏è Server file should be .server.luau: $file"
            fi
          done

          # Client scripts should end in .client.luau
          for file in src/mertin-flemmer/client/*.luau; do
            if [[ "$file" != *".client.luau" ]]; then
              echo "‚ö†Ô∏è Client file should be .client.luau: $file"
            fi
          done

          echo "‚úÖ File structure check passed"

      - name: Ground existence check (CRITICAL)
        run: |
          echo "üåç CRITICAL: Checking ground exists..."

          if ! grep -q "Ground_Main\|Baseplate\|createGround" src/mertin-flemmer/server/World.server.luau; then
            echo "‚ùå CRITICAL: NO GROUND FOUND! Players will fall through the world!"
            exit 1
          fi

          if ! grep -A5 "Ground_Main" src/mertin-flemmer/server/World.server.luau | grep -q "CanCollide = true"; then
            echo "‚ùå CRITICAL: Ground is not collidable!"
            exit 1
          fi

          echo "‚úÖ Ground exists and is collidable"

      - name: Spawn area check
        run: |
          echo "üè† Checking spawn area is clear..."

          # Make sure no mountains at origin
          if grep -q "basePosition = Vector3.new(0," src/mertin-flemmer/server/Mountains.server.luau 2>/dev/null; then
            echo "‚ùå Mountain at origin blocks spawn!"
            exit 1
          fi

          echo "‚úÖ Spawn area is clear"

      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "  VERIFICATION SUMMARY"
          echo "=========================================="
          echo ""

          # Count files
          SERVER_COUNT=$(find src/mertin-flemmer/server -name "*.luau" | wc -l)
          CLIENT_COUNT=$(find src/mertin-flemmer/client -name "*.luau" | wc -l)
          SHARED_COUNT=$(find src/mertin-flemmer/shared -name "*.luau" | wc -l)
          TOTAL_LINES=$(find src/mertin-flemmer -name "*.luau" -exec cat {} \; | wc -l)

          echo "üìä Files: Server=$SERVER_COUNT, Client=$CLIENT_COUNT, Shared=$SHARED_COUNT"
          echo "üìä Total lines of Luau: $TOTAL_LINES"
          echo ""
